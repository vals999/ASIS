<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Barrios</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" (click)="toggleFormularioAlta()">
        Crear Barrio
      </button>
      <input type="text" class="form-control" style="width: 250px;" placeholder="Buscar..." 
             [ngModel]="search()" (ngModelChange)="updateSearch($event)">
    </div>
  </div>

  <form *ngIf="mostrarFormularioAlta()" (ngSubmit)="crearBarrio()" class="mb-4 border rounded p-3 bg-light">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Nombre del barrio</label>
        <input type="text" class="form-control" 
               [ngModel]="nuevoBarrio().nombre" 
               (ngModelChange)="updateNuevoBarrioNombre($event)" 
               name="nombre" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Geolocalización</label>
        <div class="input-group">
          <input type="text" class="form-control" 
                 [ngModel]="nuevoBarrio().geolocalizacion" 
                 (ngModelChange)="updateNuevoBarrioGeolocalizacion($event)" 
                 name="geolocalizacion" 
                 placeholder="Haz clic en el mapa para seleccionar" 
                 readonly>
          <button type="button" class="btn btn-outline-primary" 
                  (click)="abrirSelectorCoordenadas('nuevo')"
                  title="Seleccionar en mapa">
            <i class="bi bi-geo-alt"></i>
          </button>
        </div>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-success w-100">Guardar</button>
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-secondary w-100" (click)="cancelarAlta()">Cancelar</button>
      </div>
    </div>
    
    <!-- Mensaje de confirmación -->
    <div *ngIf="mensajeExito()" class="alert mt-3 mb-0" 
         [ngClass]="mensajeExito().includes('Error') ? 'alert-danger' : 'alert-success'">
      <i [class]="mensajeExito().includes('Error') ? 'fa fa-exclamation-circle' : 'fa fa-check-circle'"></i>
      {{ mensajeExito() }}
    </div>
  </form>

  <table class="table table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Geolocalización</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let barrio of barriosFiltrados()">
        <!-- Fila normal del barrio -->
        <tr>
          <td>#{{ barrio.id }}</td>
          <td>{{ barrio.nombre }}</td>
          <td>{{ barrio.geolocalizacion }}</td>
          <td>
            <a href="#" class="me-2" (click)="$event.preventDefault(); editarBarrio(barrio)">Editar</a>
            <a href="#" class="text-danger" (click)="$event.preventDefault(); eliminarBarrio(barrio.id)">Eliminar</a>
          </td>
        </tr>
        
        <!-- Fila del formulario de edición (solo se muestra si el barrio está siendo editado) -->
        <tr *ngIf="barrioEditando() === barrio.id" class="bg-light">
          <td colspan="4">
            <div class="p-3 border rounded">
              <h6 class="mb-3">Editar Barrio #{{ barrio.id }}</h6>
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label">Nombre del barrio</label>
                  <input type="text" class="form-control" 
                         [ngModel]="barrioEditado().nombre" 
                         (ngModelChange)="updateBarrioEditadoNombre($event)" 
                         required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Geolocalización</label>
                  <div class="input-group">
                    <input type="text" class="form-control" 
                           [ngModel]="barrioEditado().geolocalizacion" 
                           (ngModelChange)="updateBarrioEditadoGeolocalizacion($event)" 
                           placeholder="Haz clic en el mapa para seleccionar" 
                           readonly>
                    <button type="button" class="btn btn-outline-primary" 
                            (click)="abrirSelectorCoordenadas('editado')"
                            title="Seleccionar en mapa">
                      <i class="bi bi-geo-alt"></i>
                    </button>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="d-flex flex-column gap-1 mt-4">
                    <button type="button" class="btn btn-success btn-sm" (click)="confirmarEdicion()">
                      <i class="fa fa-check"></i> Confirmar
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" (click)="cancelarEdicion()">
                      <i class="fa fa-times"></i> Cancelar
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Mensaje de validación dentro del formulario de edición -->
              <div *ngIf="mensajeEdicion()" class="alert mt-3 mb-0" 
                   [ngClass]="mensajeEdicion().includes('Error') ? 'alert-danger' : 'alert-success'">
                <i [class]="mensajeEdicion().includes('Error') ? 'fa fa-exclamation-circle' : 'fa fa-check-circle'"></i>
                {{ mensajeEdicion() }}
              </div>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>
  
  <!-- Paginación simple (opcional) -->
  <nav *ngIf="barriosFiltrados().length > 10">
    <ul class="pagination justify-content-end">
      <li class="page-item disabled"><a class="page-link">Anterior</a></li>
      <li class="page-item active"><a class="page-link">1</a></li>
      <li class="page-item"><a class="page-link">Siguiente</a></li>
    </ul>
  </nav>

  <!-- Modal selector de coordenadas -->
  @if (mostrarSelectorCoordenadas()) {
    <app-coordenadas-selector 
      [coordenadasIniciales]="obtenerCoordenadasActuales()"
      (coordenadasSelected)="onCoordenadasSeleccionadas($event)"
      (modalClosed)="cerrarSelectorCoordenadas()">
    </app-coordenadas-selector>
  }
</div>
